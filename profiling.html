<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/markdown/profiling.md at 2021-11-10
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20211110" />
    <meta http-equiv="Content-Language" content="en" />
    <title>spf4j-8.9.3-SNAPSHOT &#x2013; Profiling</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script type="text/javascript" src="./js/apache-maven-fluido-1.7.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>SPF4J</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2021-11-10<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 8.9.3-SNAPSHOT</li>
      <li class="pull-right"><a href="./" title="SPF4J">SPF4J</a></li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">Main Menu</li>
    <li><a href="index.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="http://search.maven.org/#search|ga|1|spf4j" class="externalLink" title="Download"><span class="none"></span>Download</a></li>
      <li class="nav-header">Modules</li>
    <li><a href="spf4j-aether/index.html" title="spf4j-aether"><span class="none"></span>spf4j-aether</a></li>
    <li><a href="spf4j-asm/index.html" title="spf4j-asm"><span class="none"></span>spf4j-asm</a></li>
    <li><a href="spf4j-config-discovery-maven-plugin/index.html" title="spf4j-config-discovery-maven-plugin"><span class="none"></span>spf4j-config-discovery-maven-plugin</a></li>
    <li><a href="spf4j-jdiff-maven-plugin/index.html" title="spf4j-jdiff-maven-plugin"><span class="none"></span>spf4j-jdiff-maven-plugin</a></li>
    <li><a href="spf4j-core/index.html" title="spf4j-core"><span class="none"></span>spf4j-core</a></li>
    <li><a href="spf4j-slf4j-test/index.html" title="spf4j-slf4j-test"><span class="none"></span>spf4j-slf4j-test</a></li>
    <li><a href="spf4j-slf4j-test-junit5/index.html" title="spf4j-slf4j-test-junit5"><span class="none"></span>spf4j-slf4j-test-junit5</a></li>
    <li><a href="spf4j-joda/index.html" title="spf4j-joda"><span class="none"></span>spf4j-joda</a></li>
    <li><a href="spf4j-core-gwt/index.html" title="spf4j-core-gwt"><span class="none"></span>spf4j-core-gwt</a></li>
    <li><a href="spf4j-junit/index.html" title="spf4j-junit"><span class="none"></span>spf4j-junit</a></li>
    <li><a href="spf4j-jmh/index.html" title="spf4j-jmh"><span class="none"></span>spf4j-jmh</a></li>
    <li><a href="spf4j-jmh-11/index.html" title="spf4j-jmh-11"><span class="none"></span>spf4j-jmh-11</a></li>
    <li><a href="spf4j-ui/index.html" title="spf4j-ui"><span class="none"></span>spf4j-ui</a></li>
    <li><a href="spf4j-aspects/index.html" title="spf4j-aspects"><span class="none"></span>spf4j-aspects</a></li>
    <li><a href="spf4j-zel/index.html" title="spf4j-zel"><span class="none"></span>spf4j-zel</a></li>
    <li><a href="spf4j-zel-javax/index.html" title="spf4j-zel-javax"><span class="none"></span>spf4j-zel-javax</a></li>
    <li><a href="spf4j-avro-components/index.html" title="spf4j-avro-components"><span class="none"></span>spf4j-avro-components</a></li>
    <li><a href="spf4j-jacoco-aggregate/index.html" title="spf4j-jacoco-aggregate"><span class="none"></span>spf4j-jacoco-aggregate</a></li>
    <li><a href="spf4j-maven-schema-resolver/index.html" title="spf4j-maven-schema-resolver"><span class="none"></span>spf4j-maven-schema-resolver</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>Profiling</h1>
<p>It all started with Brendan Gregg&#x2019;s blog: <a class="externalLink" href="http://dtrace.org/blogs/brendan/2011/12/16/flame-graphs/">http://dtrace.org/blogs/brendan/2011/12/16/flame-graphs/</a> and a few hours later the &#x201c;stack monitor&#x201d; was published to google code. However, since then more profiling capability has been added to spf4j:</p>
<ul>

<li>

<p>Improved Flame-graph visualization to better see hot-spots.</p>
</li>
<li>

<p>Request attributed profiling. The Spf4j Stack sampler has been integrated with the application <a class="externalLink" href="https://github.com/zolyfarkas/spf4j/blob/master/spf4j-core/src/main/java/org/spf4j/base/ExecutionContext.java">ExecutionContexts</a> enabling more granular profiling detail like described <a class="externalLink" href="https://github.com/zolyfarkas/jaxrs-spf4j-demo/wiki/ContinuousProfiling">at</a></p>
</li>
<li>

<p>Aspects to monitor object allocation, network, file, memory, garbage collection usage have been added. One of the main advantages of spf4j is that it can be easily be used for continuous profiling. The captured profile data is persisted to ssdump files which can be opened and visualized with the spf4j UI.</p>
</li>
</ul>
<p>Over time the Spf4j Stack sampler has been integrated with the application <a class="externalLink" href="https://github.com/zolyfarkas/spf4j/blob/master/spf4j-core/src/main/java/org/spf4j/base/ExecutionContext.java">ExecutionContexts</a> enabling more granular profiling detail like described <a class="externalLink" href="https://github.com/zolyfarkas/jaxrs-spf4j-demo/wiki/ContinuousProfiling">at</a></p>
<div class="section">
<h2><a name="Context_correlated_profiling_overview"></a>Context correlated profiling overview</h2>
<p><img src="images/ContextCorelatedProfiling.svg" alt="Context correlated profiling" /></p>
<p>Simpler approach of sampling all threads is available.</p></div>
<div class="section">
<h2><a name="When_to_profile_your_code.3F"></a>When to profile your code?</h2>
<p>I recommend to deploy your code with profiling turned on as much as you can. In my case I have profiling data collection turned on in all environments (including productiton) all the time.</p>
<p>Another good time to profile your code is during your JMH (<a class="externalLink" href="http://openjdk.java.net/projects/code-tools/jmh/">http://openjdk.java.net/projects/code-tools/jmh/</a>) benchmarks. A good practice is to have a benchmark module in your project, that will benchmark key functionality of your application. These benchmarks will be run as part of your build process, and you can monitor the performance of your project with a Jenkins JMH <a class="externalLink" href="https://github.com/blackboard/jmh-jenkins">plugin</a></p>
<p>Your Unit tests are not immune to profiling either. With spf4j-junit you can also easily profile your unit tests with Spf4jRunListener.</p></div>
<div class="section">
<h2><a name="How_to_profile_your_code"></a>How to profile your code</h2>
<div class="section">
<h3><a name="How_to_profile_your_java_REST_service."></a>How to profile your java REST service.</h3>
<p>If you are running a REST service, see a example <a class="externalLink" href="https://github.com/zolyfarkas/jaxrs-spf4j-demo">at</a>. running live <a class="externalLink" href="https://demo.spf4j.org">at</a></p>
<p>For details on request attributed profiling <a class="externalLink" href="https://github.com/zolyfarkas/jaxrs-spf4j-demo/wiki/ContinuousProfiling">see</a></p>
<p>For aggregated profiling <a class="externalLink" href="https://github.com/zolyfarkas/jaxrs-spf4j-demo/wiki/ContinuousProfiling2">see</a></p></div>
<div class="section">
<h3><a name="Profiling_a_existing_java_application_without_code_changes"></a>Profiling a existing java application without code changes</h3>
<p>Add spf4j to your classpath and the following to your command line:</p>

<div>
<div>
<pre class="source">${JAVA_HOME}/bin/java [your jvm args] org.spf4j.stackmonitor.Monitor -df [folder to write date] -dp [file prefix] -ss -si 100  -main [your app main class] -- [your app arguments]
</pre></div></div>

<p>This will start your application with profiling enabled, with a 100 ms sampling interval. After the process ends ssdump file will ge generated containing the profiling data. Profiling can also be enabled/disabled via JMX.</p>
<p>Supported arguments:</p>

<div>
<div>
<pre class="source">Usage:
 -df VAL   : dump folder (default: ./target)
 -di N     : the stack dump to file interval in milliseconds (default: 3600000)
 -dp VAL   : dump file prefix (default: ManagementFactory.getRuntimeMXBean().getName())
 -main VAL : the main class name
 -si N     : the stack sampling interval in milliseconds (default: 100)
 -ss       : start the stack sampling thread. (can also be done manually via
             jmx) (default: false)
</pre></div></div>
</div>
<div class="section">
<h3><a name="Existing_java_application_with_code_changes"></a>Existing java application with code changes</h3>
<p>You can also run and control the profiler via its java API:</p>

<div>
<div>
<pre class="source">    Sampler SAMPLER = new Sampler(SAMPLE_PERIOD_MSEC);
    SAMPLER.start();
    SAMPLER.stop();
    SampleNode collected = SAMPLER.getStackCollector().clear();
    Converter.saveToFile(fileName, collected);

</pre></div></div>
</div>
<div class="section">
<h3><a name="Profile_your_JMH_benchmarks"></a>Profile your JMH benchmarks</h3>
<p>If you want to profile your JMH benchmarks you can simply add the spf4j JMH profiler to your startup options:</p>

<div>
<div>
<pre class="source">        Options opt = new OptionsBuilder()
                .include(&quot;.*&quot;)
                .addProfiler(JmhProfiler.class)
                .build();
         new Runner(opt).run();

</pre></div></div>

<p>The profiling measurements will be save to file into the current dir. They can be opened and analized with the spf4j-ui.</p>
<p>Spf4j contains also a JMH Profiler integration for Java Flight Recorder, to use it all you need to do is:</p>

<div>
<div>
<pre class="source">        Options opt = new OptionsBuilder()
                .include(&quot;.*&quot;)
                .addProfiler(JmhFlightRecorderProfiler.class)
                .build();
         new Runner(opt).run();

</pre></div></div>

<p>Java flight recorder should not have the safe point bias that spf4j has, however java flight recorder is a commercial feature that requires a license from Oracle for production use. For production use spf4j profiler is a zero cost alternative, which due to its simplicity should be a more reliable option as well.</p>
<p>THe Jmh integration is available in spf4j-jmh module:</p>

<div>
<div>
<pre class="source">        &lt;dependency&gt;
            &lt;groupId&gt;org.spf4j&lt;/groupId&gt;
            &lt;artifactId&gt;spf4j-jmh&lt;/artifactId&gt;
            &lt;version&gt;...&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
</pre></div></div>
</div></div>
<div class="section">
<h2><a name="How_to_see_the_profile_data.3F"></a>How to see the profile data?</h2>
<p>After the program finishes and during execution it will write the data to <a href="jaxrs-spf4j-demo_20200131T160810753Z_20200131T170850286Z.ssdump3.gz">ssdump</a> files.</p>
<p>If you are running with the REST actuator, you can visualize your data like in this <a class="externalLink" href="https://demo.spf4j.org/profiles/cluster/visualize/groups/GET">live example</a>. (see the &#x201c;How to profile your java REST service&#x201d; section for more detail.)</p>
<p>If you have a server application running and you started it with stack sampling, by default every 1 hour the collected stack data is dumped to the temp folder. You can also invoke Sampler.dumpToFile to dump the stack samples at any time in your program allowing you to separate out samples at relevant times in your application. You can load and visualize this data with the library embedded ui:</p>
<p><img src="images/spf4j-flame-graph.png" alt="Flame Graph" /></p>
<p>The classic flame graph visualization remains available. The explorer ui can be used to visualize the measurements stored in the tsdb files. You can also export the measurements to csv format allowing you to analyze them with tools like excel.</p>
<p><img src="images/explorer-ui.png" alt="Explorer UI" /></p>
<p>in the UI you can filter certain stack traces by right clicking on them and using the filter option in the context menu.</p></div>
<div class="section">
<h2><a name="How_does_it_work.3F"></a>How does it work?</h2>
<p>A sampling thread is started and running in the background. This thread uses Thread.getAllStackTraces() or the JVM MX beans (configurable) to get all stack traces for all threads. Each sample is added to a tree that aggregates the stack trace data.</p></div>
<div class="section">
<h2><a name="Monitoring_memory_allocations:"></a>Monitoring memory allocations:</h2>
<p>You will need to apply aspect org.spf4j.memorymonitor.AllocationMonitorAspect to the code you want to monitor object allocations. This aspect will intercept all new objects calls in your code and it will use performance monitoring described at chapter 4 to record the number and amount of allocations. AspectJ load time weaving is not capable of intercepting allocations done inside rt.jar. You will have to apply your aspect against rt.jar and create a new one and add it to the boot class path in case you want to see all allocations.</p>
<p>Getting access to the data is same as described in chapter 4, you can do it over jmx, or opening the tsdb file in the embeded ui:</p>
<p><img src="images/spf4j_allocations.png" alt="allocations" /></p>
<p>Allocations are classified based on the class where they are done. This allows you to quickly identify memory hogs. In the chart above you can see how memory allocations happened, both byteSize and allocation count and what class. Object size computation might be too much overhead, in that case you can disable it by system property setting:</p>

<div>
<div>
<pre class="source">-Dperf.allocations.recordSize=false
</pre></div></div>

<div class="section">
<h3><a name="Monitoring_Network_IO"></a>Monitoring Network IO</h3>
<p>The aspect org.spf4j.iomonitor.NetworkMonitorAspect will allow you to monitor you processes network traffic.</p>
<p><img src="images/spf4j_io.png" alt="network traffic" /> network traffic</p></div>
<div class="section">
<h3><a name="Monitoring_Memory_Usage"></a>Monitoring Memory Usage</h3>
<p>By calling MemoryUsageSampler.startMemoryUsageSampling(sampleTime) memory usage will be sampled at the provided interval. Sampled data ill be aggregated at the interval set by perf.memory.sampleAggMillis system property. Data will be stored into a spf4j tsdb where data can be accessed via jmx or the sf4j ui.</p></div>
<div class="section">
<h3><a name="Monitoring_File_Usage"></a>Monitoring File Usage</h3>
<p>By calling OpenFilesSampler.startFileUsageSampling(sampleTime, warnThreshold, errorThreshold), file usage will be sampled at the provided interval. This is usefull to see open files trend and detect file handle leaks, which will cause in general outages of your application. The warn and error threshold numbers will long details provided by lsof to help you troubleshoot what is going on. Sampled data will be aggregated at the interval set by perf.io.openFiles.sampleAggMillis system property. Data will be stored into a spf4j tsdb where data can be accessed via jmx or the sf4j ui.</p></div></div>
<div class="section">
<h2><a name="Notes"></a>Notes</h2>
<p>Due to the use of Thread.getStackTraces() the profile data is safe point biased, which is an important aspect to consider when analyzing your profile results. For more detail on safepoint bias see:</p>
<p><a class="externalLink" href="http://psy-lob-saw.blogspot.com/2016/02/why-most-sampling-java-profilers-are.html">Blog post on safepoint bias</a></p>
<p><a class="externalLink" href="http://sape.inf.usi.ch/publications/pldi10">Evaluating the accuracy of Java profilers</a></p>
<p><a class="externalLink" href="https://github.com/RichardWarburton/honest-profiler">Honest profiler</a> also <a class="externalLink" href="(https://www.youtube.com/watch?v=Yg6_ulhwLw0)">see</a></p></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2021
<a href="http://www.spf4j.org">SPF4J</a>.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
