<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>StackVisualizer.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">spf4j-zel</a> &gt; <a href="../index.html" class="el_bundle">spf4j-core</a> &gt; <a href="index.source.html" class="el_package">org.spf4j.stackmonitor</a> &gt; <span class="el_source">StackVisualizer.java</span></div><h1>StackVisualizer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2001-2017, Zoltan Farkas All Rights Reserved.
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 *
 * Additionally licensed with:
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.spf4j.stackmonitor;

import com.google.common.html.HtmlEscapers;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import gnu.trove.map.TMap;
import java.io.IOException;
import java.io.Writer;
import java.util.Map;
import org.spf4j.base.Methods;
import org.spf4j.base.StackSamples;
import org.spf4j.base.avro.Method;

/**
 * utility class to generate svg and html out of stack samples.
 *
 * @author zoly
 */
@SuppressFBWarnings({&quot;CBX_CUSTOM_BUILT_XML&quot;, &quot;PREDICTABLE_RANDOM&quot;})
public final class StackVisualizer {

<span class="nc" id="L52">  private static final String[] COLORS = {&quot;#CCE01B&quot;,</span>
    &quot;#DDE01B&quot;, &quot;#EEE01B&quot;, &quot;#FFE01B&quot;, &quot;#FFD01B&quot;,
    &quot;#FFC01B&quot;, &quot;#FFA01B&quot;, &quot;#FF901B&quot;, &quot;#FF801B&quot;,
    &quot;#FF701B&quot;, &quot;#FF601B&quot;, &quot;#FF501B&quot;, &quot;#FF401B&quot;};

  private StackVisualizer() {
  }

  public static void generateHtmlTable(final Writer writer, final Method m,
          final StackSamples node, final int tableWidth, final int maxDepth) throws IOException {
<span class="nc" id="L62">    TMap&lt;Method, ? extends StackSamples&gt; subNodes = node.getSubNodes();</span>
<span class="nc" id="L63">    writer.append(&quot;&lt;table border=\&quot;0\&quot; cellpadding=\&quot;0\&quot; cellspacing=\&quot;0\&quot; &quot;</span>
            + &quot;style=\&quot;overflow:hidden;table-layout:fixed;width:&quot;).
<span class="nc" id="L65">            append(Integer.toString(tableWidth)).append(&quot;px\&quot;&gt;\n&quot;);</span>
<span class="nc" id="L66">    int totalSamples = node.getSampleCount();</span>

<span class="nc bnc" id="L68" title="All 4 branches missed.">    if (maxDepth &gt; 0 &amp;&amp; !subNodes.isEmpty()) {</span>
<span class="nc" id="L69">      writer.append(&quot;&lt;tr style=\&quot;height:1em\&quot;&gt;&quot;);</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">      for (Map.Entry&lt;Method, ? extends StackSamples&gt; entry : subNodes.entrySet()) {</span>
<span class="nc" id="L71">        int width = entry.getValue().getSampleCount() * tableWidth / totalSamples;</span>
<span class="nc" id="L72">        writer.append(&quot;&lt;td style=\&quot;vertical-align:bottom; width:&quot;).</span>
<span class="nc" id="L73">                append(Integer.toString(width)).append(&quot;px\&quot;&gt;&quot;);</span>
<span class="nc" id="L74">        generateHtmlTable(writer, entry.getKey(), entry.getValue(), width, maxDepth - 1);</span>
<span class="nc" id="L75">        writer.append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L76">      }</span>
<span class="nc" id="L77">      writer.append(&quot;&lt;td&gt;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L78">      writer.append(&quot;&lt;/tr&gt;\n&quot;);</span>
    }
<span class="nc" id="L80">    writer.append(&quot;&lt;tr style=\&quot;height:1em\&quot; &gt;&lt;td &quot;);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">    if (!subNodes.isEmpty()) {</span>
<span class="nc" id="L82">      writer.append(&quot;colspan=\&quot;&quot;).append(Integer.toString(subNodes.size() + 1)).append(&quot;\&quot; &quot;);</span>
    }
<span class="nc" id="L84">    writer.append(&quot; title=\&quot;&quot;);</span>
<span class="nc" id="L85">    Methods.writeHtml(m, writer);</span>
<span class="nc" id="L86">    writer.append(&quot;:&quot;);</span>
<span class="nc" id="L87">    writer.append(Integer.toString(node.getSampleCount()));</span>
<span class="nc" id="L88">    writer.append(&quot;\&quot; style=\&quot;overflow:hidden;width:100%;vertical-align:bottom ;background:&quot;).</span>
<span class="nc" id="L89">            append(COLORS[(int) (Math.random() * COLORS.length)]).append(&quot;\&quot;&gt;&quot;);</span>
<span class="nc" id="L90">    Methods.writeHtml(m, writer);</span>
<span class="nc" id="L91">    writer.append(&quot;:&quot;);</span>
<span class="nc" id="L92">    writer.append(Integer.toString(totalSamples));</span>
<span class="nc" id="L93">    writer.append(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);</span>

<span class="nc" id="L95">    writer.append(&quot;&lt;/table&gt;\n&quot;);</span>
<span class="nc" id="L96">  }</span>

  public static void generateSvg(final Writer writer, final Method m,
          final SampleNode node, final int x, final int y,
          final int width, final int maxDepth, final String idPfx) throws IOException {
<span class="nc bnc" id="L101" title="All 2 branches missed.">    if (width &lt; 200) {</span>
<span class="nc" id="L102">      throw new IllegalArgumentException(&quot;width must be greater than 200, it is &quot; + width);</span>
    }
<span class="nc" id="L104">    writer.append(&quot;&lt;svg width=\&quot;&quot; + width + &quot;\&quot; height= \&quot;&quot; + (15 * node.height() + 15) + &quot;\&quot; onload=\&quot;&quot;</span>
            + idPfx + &quot;init(evt)\&quot; &gt;\n&quot;);
<span class="nc" id="L106">    writer.append(&quot;&lt;script type=\&quot;text/ecmascript\&quot;&gt;\n&quot;</span>
            + &quot;&lt;![CDATA[\n&quot;
            + &quot;var &quot; + idPfx + &quot;tooltip;\n&quot;
            + &quot;var &quot; + idPfx + &quot;tooltip_bg;\n&quot;
            + &quot;function &quot; + idPfx + &quot;init(evt)\n&quot;
            + &quot;  {\n&quot;
            + &quot;    if ( window.svgDocument == null )\n&quot;
            + &quot;    {\n&quot;
            + &quot;      svgDocument = evt.target.ownerDocument;\n&quot;
            + &quot;    }\n&quot;
            + &quot;    &quot; + idPfx + &quot;tooltip = svgDocument.getElementById('&quot; + idPfx + &quot;tooltip'); &quot;
            + idPfx + &quot;tooltip_bg = svgDocument.getElementById('&quot; + idPfx + &quot;tooltip_bg');&quot;
            + &quot;  }\n&quot;
            + &quot;function &quot; + idPfx + &quot;ss(evt, mouseovertext, xx, yy)\n&quot;
            + &quot;{\n&quot;
            + &quot;  &quot; + idPfx + &quot;tooltip.setAttributeNS(null,\&quot;x\&quot;,xx );\n&quot;
            + &quot;  &quot; + idPfx + &quot;tooltip.setAttributeNS(null,\&quot;y\&quot;,yy+13 );\n&quot;
            + &quot;  &quot; + idPfx + &quot;tooltip.firstChild.data = mouseovertext;\n&quot;
            + &quot;  &quot; + idPfx + &quot;tooltip.setAttributeNS(null,\&quot;visibility\&quot;,\&quot;visible\&quot;);\n&quot;
            + &quot;length = &quot; + idPfx + &quot;tooltip.getComputedTextLength();\n&quot;
            + idPfx + &quot;tooltip_bg.setAttributeNS(null,\&quot;width\&quot;,length+8);\n&quot;
            + idPfx + &quot;tooltip_bg.setAttributeNS(null,\&quot;x\&quot;,xx);\n&quot;
            + idPfx + &quot;tooltip_bg.setAttributeNS(null,\&quot;y\&quot;,yy);\n&quot;
            + idPfx + &quot;tooltip_bg.setAttributeNS(null,\&quot;visibility\&quot;,\&quot;visibile\&quot;);&quot;
            + &quot;}\n&quot;
            + &quot;function &quot; + idPfx + &quot;hh()\n&quot;
            + &quot;{\n&quot;
            + &quot;  &quot; + idPfx + &quot;tooltip.setAttributeNS(null,\&quot;visibility\&quot;,\&quot;hidden\&quot;);\n&quot;
            + idPfx + &quot;tooltip_bg.setAttributeNS(null,\&quot;visibility\&quot;,\&quot;hidden\&quot;);\n&quot;
            + &quot;}]]&gt;&quot;
            + &quot;&lt;/script&gt;&quot;);

<span class="nc" id="L138">    generateSubSvg(writer, m, node, x, y + 15, width - 100, maxDepth, idPfx);</span>

<span class="nc" id="L140">    writer.append(&quot;&lt;rect fill=\&quot;rgb(255,255,255)\&quot; id=\&quot;&quot; + idPfx + &quot;tooltip_bg\&quot;\n&quot;</span>
            + &quot;      x=\&quot;0\&quot; y=\&quot;0\&quot; rx=\&quot;4\&quot; ry=\&quot;4\&quot;\n&quot;
            + &quot;      width=\&quot;55\&quot; height=\&quot;17\&quot; visibility=\&quot;hidden\&quot;/&gt;&quot;);
<span class="nc" id="L143">    writer.append(&quot;&lt;text font-size=\&quot;12\&quot; font-family=\&quot;Verdana\&quot; fill=\&quot;rgb(0,0,0)\&quot;  id=\&quot;&quot;</span>
            + idPfx + &quot;tooltip\&quot; x=\&quot;0\&quot; y=\&quot;0\&quot; visibility=\&quot;hidden\&quot;&gt;Tooltip&lt;/text&gt;&quot;);
<span class="nc" id="L145">    writer.append(&quot;&lt;/svg&gt;\n&quot;);</span>
<span class="nc" id="L146">  }</span>

  @SuppressFBWarnings(&quot;ISB_TOSTRING_APPENDING&quot;)
  public static void generateSubSvg(final Writer writer, final Method m, final StackSamples node,
          final int x, final int y, final int width, final int maxDepth, final String idPfx) throws IOException {

<span class="nc" id="L152">    Map&lt;Method, ? extends StackSamples&gt; subNodes = node.getSubNodes();</span>

<span class="nc" id="L154">    int totalSamples = node.getSampleCount();</span>
<span class="nc" id="L155">    String id = idPfx + &quot;ix&quot; + x + 'y' + y;</span>
<span class="nc" id="L156">    String content = HtmlEscapers.htmlEscaper().escape(m.toString() + ':' + totalSamples);</span>
<span class="nc" id="L157">    writer.append(&quot;&lt;g onmouseover=\&quot;&quot; + idPfx + &quot;ss(evt,'&quot; + content + &quot;',&quot; + x + &quot;, &quot;</span>
            + y + &quot; )\&quot; onmouseout=\&quot;&quot; + idPfx + &quot;hh()\&quot;&gt;&quot;);
<span class="nc" id="L159">    writer.append(&quot;&lt;rect id=\&quot;&quot; + id + &quot;\&quot; x=\&quot;&quot; + x + &quot;\&quot; y=\&quot;&quot; + y + &quot;\&quot; width=\&quot;&quot; + width</span>
            + &quot;\&quot; height=\&quot;15\&quot; fill=\&quot;&quot;
<span class="nc" id="L161">            + COLORS[(int) (Math.random() * COLORS.length)] + &quot;\&quot;  /&gt;&quot;);</span>

<span class="nc" id="L163">    writer.append(&quot;&lt;text x=\&quot;&quot; + x + &quot;\&quot; y=\&quot;&quot; + (y + 13)</span>
            + &quot;\&quot; font-size=\&quot;12\&quot; font-family=\&quot;Verdana\&quot; fill=\&quot;rgb(0,0,0)\&quot; &quot;
            + &quot; &gt;&quot;);
<span class="nc" id="L166">    writer.append(content.substring(0, Math.min(width / 9, content.length())));</span>
<span class="nc" id="L167">    writer.append(&quot;&lt;/text&gt;\n&quot;);</span>
<span class="nc" id="L168">    writer.append(&quot;&lt;/g&gt;&quot;);</span>

<span class="nc bnc" id="L170" title="All 4 branches missed.">    if (maxDepth &gt; 0 &amp;&amp; !subNodes.isEmpty()) {</span>
<span class="nc" id="L171">      int rx = 0;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">      for (Map.Entry&lt;Method, ? extends StackSamples&gt; entry : subNodes.entrySet()) {</span>
<span class="nc" id="L173">        int cwidth = (int) (((long) entry.getValue().getSampleCount()) * width / totalSamples);</span>
<span class="nc" id="L174">        generateSubSvg(writer, entry.getKey(), entry.getValue(), rx + x, y + 15, cwidth, maxDepth - 1, idPfx);</span>
<span class="nc" id="L175">        rx += cwidth;</span>
<span class="nc" id="L176">      }</span>

    }
<span class="nc" id="L179">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>