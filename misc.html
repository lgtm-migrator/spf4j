<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/markdown/misc.md at 2021-11-10
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20211110" />
    <meta http-equiv="Content-Language" content="en" />
    <title>spf4j-8.9.3-SNAPSHOT &#x2013; Other components shipped part of the spf4j library.</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script type="text/javascript" src="./js/apache-maven-fluido-1.7.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>SPF4J</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2021-11-10<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 8.9.3-SNAPSHOT</li>
      <li class="pull-right"><a href="./" title="SPF4J">SPF4J</a></li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">Main Menu</li>
    <li><a href="index.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="http://search.maven.org/#search|ga|1|spf4j" class="externalLink" title="Download"><span class="none"></span>Download</a></li>
      <li class="nav-header">Modules</li>
    <li><a href="spf4j-aether/index.html" title="spf4j-aether"><span class="none"></span>spf4j-aether</a></li>
    <li><a href="spf4j-asm/index.html" title="spf4j-asm"><span class="none"></span>spf4j-asm</a></li>
    <li><a href="spf4j-config-discovery-maven-plugin/index.html" title="spf4j-config-discovery-maven-plugin"><span class="none"></span>spf4j-config-discovery-maven-plugin</a></li>
    <li><a href="spf4j-jdiff-maven-plugin/index.html" title="spf4j-jdiff-maven-plugin"><span class="none"></span>spf4j-jdiff-maven-plugin</a></li>
    <li><a href="spf4j-core/index.html" title="spf4j-core"><span class="none"></span>spf4j-core</a></li>
    <li><a href="spf4j-slf4j-test/index.html" title="spf4j-slf4j-test"><span class="none"></span>spf4j-slf4j-test</a></li>
    <li><a href="spf4j-slf4j-test-junit5/index.html" title="spf4j-slf4j-test-junit5"><span class="none"></span>spf4j-slf4j-test-junit5</a></li>
    <li><a href="spf4j-joda/index.html" title="spf4j-joda"><span class="none"></span>spf4j-joda</a></li>
    <li><a href="spf4j-core-gwt/index.html" title="spf4j-core-gwt"><span class="none"></span>spf4j-core-gwt</a></li>
    <li><a href="spf4j-junit/index.html" title="spf4j-junit"><span class="none"></span>spf4j-junit</a></li>
    <li><a href="spf4j-jmh/index.html" title="spf4j-jmh"><span class="none"></span>spf4j-jmh</a></li>
    <li><a href="spf4j-jmh-11/index.html" title="spf4j-jmh-11"><span class="none"></span>spf4j-jmh-11</a></li>
    <li><a href="spf4j-ui/index.html" title="spf4j-ui"><span class="none"></span>spf4j-ui</a></li>
    <li><a href="spf4j-aspects/index.html" title="spf4j-aspects"><span class="none"></span>spf4j-aspects</a></li>
    <li><a href="spf4j-zel/index.html" title="spf4j-zel"><span class="none"></span>spf4j-zel</a></li>
    <li><a href="spf4j-zel-javax/index.html" title="spf4j-zel-javax"><span class="none"></span>spf4j-zel-javax</a></li>
    <li><a href="spf4j-avro-components/index.html" title="spf4j-avro-components"><span class="none"></span>spf4j-avro-components</a></li>
    <li><a href="spf4j-jacoco-aggregate/index.html" title="spf4j-jacoco-aggregate"><span class="none"></span>spf4j-jacoco-aggregate</a></li>
    <li><a href="spf4j-maven-schema-resolver/index.html" title="spf4j-maven-schema-resolver"><span class="none"></span>spf4j-maven-schema-resolver</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>Other components shipped part of the spf4j library.</h1>
<div class="section">
<h2><a name="High_Performance_Object_Pool"></a>High Performance Object Pool</h2>
<div class="section">
<h3><a name="Why_another_object_pool_implementation.3F"></a>Why another object pool implementation?</h3>
<p>In my(I am not alone) view current available object pool implementations are less than perfect. Beside the scalability issues and bugs, this implementation improves upon:</p>
<ul>

<li>

<p>Test on borrow is pointless, there is no guarantee that you will get a valid object even if you test on borrow. This encourages the developer to disregard handling of this case when it receives an invalid object. This practice also often is a performance issue, and it is not supported by the spf4j implementation.</p>
</li>
<li>

<p>Indiscriminate test on return is not optimal either. Test on return should be done only in the case where there is a suspicion that the object is invalid, otherwise the performance impact will be too high to be acceptable in most cases. Pool client should be able to provide feedback on return for that case, and as such the client is able to provide encountered error information to the pool on return. As such the pool can test the connection before making it available again to a borrower.</p>
</li>
<li>

<p>Exception swallowing and root cause loss. The spf4j connection pool makes sure errors  and root causes are not dropped.</p>
</li>
</ul></div>
<div class="section">
<h3><a name="Use_case"></a>Use case</h3>
<p>The classical use case for an object pool is to pool your jdbc connections or any type of network connection.</p></div>
<div class="section">
<h3><a name="How_to_use_the_object_pool"></a>How to use the object pool</h3>
<p>Creating a pool is simple:</p>

<div>
<div>
<pre class="source">RecyclingSupplier&lt;ExpensiveTestObject&gt; pool = new RecyclingSupplierBuilder(10, new ExpensiveTestObjectFactory()).build();
</pre></div></div>

<p>at minimum you will need to provide the maximum size and the object factory. To do something with a object from a pool you will need to:</p>

<div>
<div>
<pre class="source">Template.doOnSupplied(new Handler&lt;PooledObject, SomeException&gt;() {
   @Override
   public void handle( PooledObject object, long deadline) throws SomeException {
   object.doStuff();
   }
}, pool, imediateRetries, maxBackoffDelay, timeout );
</pre></div></div>

<p>You can also use the get and recycle methods on the object pool to get and return an object to the pool.</p></div>
<div class="section">
<h3><a name="How_does_the_pool_work.3F"></a>How does the pool work?</h3>
<p>The architecture above biases object to threads, so a thread will most likely get the same object minimizing object contention (if pool size &gt;= thread nr which is the recommended sizing).</p>

<div>
<div>
<pre class="source">      [code context]  &lt;----&gt; [Thread Local Pool] &lt;----&gt; [Global Pool]
</pre></div></div>

<p>On the other hand this pool implementation will prefer to create a new connection instead of reusing a connection that has already has been used by another thread. This is alleviated by the maintenance process which can bring back unused local object to the global pool.</p></div></div>
<div class="section">
<h2><a name="The_Execution_Context."></a>The Execution Context.</h2>
<p>When building systems often the need arises to have parameters that address system wide concerns passed across function invocation transparently. (ThreadLocals) Some examples in practice are JDBC transaction contexts(Spring) tracing information (Opentrace/Jaeger/&#x2026;). In spf4j the main use case for something like this arised for the propagation of deadlines, which are fundamental when coding distributed systems.</p>
<p>as such the ExecutionContext can be easily created like:</p>

<div>
<div>
<pre class="source">try (ExecutionContext ctx = ExecutionContexts.start(&quot;operation_name&quot;, timeout, timeUnit)) {
  ....
}

</pre></div></div>

<p>the execution context can be retrieved with:</p>

<div>
<div>
<pre class="source">   ExecutionContext ctx = ExecutionContexts.current();
</pre></div></div>

<p>Execution contexts are transfered across Thread boundaries with: ContextPropagatingExecutorService (can wrap any executorservice) or ContextPropagationgCompletableFuture or you can create context transfering Callables and Runnables with ExecutorContexts utility methods.</p>
<p>Execution context implementations are customizeable with the system property: spf4j.execContentFactoryClass where you can specify your custom ExecutionContextFactory implementation.</p></div>
<div class="section">
<h2><a name="Retry.2Ffailure_handling_utilities."></a>Retry/failure handling utilities.</h2>
<p>Although there are other libraries that provide this functionality, I haven&#x2019;t found any that can do:</p>
<ul>

<li>1) No Exception lost + ability to propagate checked exceptions (Sync mode only).</li>
<li>2) Retry operation can be different from original operation. (redirect, fallback, etc&#x2026;)</li>
<li>3) The retry operation can be executed with delay which can be a function of the response or exception.</li>
<li>4) Timeouts are core functionality. (Support)</li>
<li>5) sync and async retry capabilities.</li>
<li>6) ability to propagate checked exceptions.</li>
</ul>
<p>Here is example:</p>

<div>
<div>
<pre class="source">        RetryPolicy.&lt;Response, ServerCall&gt;newBuilder()
           .withDeadlineSupplier((c) -&gt; c.getDeadlineNanos())
           .withDefaultThrowableRetryPredicate() // use known transient exceptions.
           .withResultPartialPredicate((resp, sc) -&gt; {
             switch (resp.getType()) {
               case CLIENT_ERROR:
                 return RetryDecision.abort();
               case REDIRECT:
                 return RetryDecision.retry(0, new ServerCall(sc.getServer(),
                         new Request((String) resp.getPayload(), sc.getRequest().getDeadlineMSEpoch())));
               case RETRY_LATER:
                 return RetryDecision.retry(
                         TimeUnit.NANOSECONDS.convert((Long) resp.getPayload() - System.currentTimeMillis(),
                                 TimeUnit.MILLISECONDS), sc);
               case TRANSIENT_ERROR:
                 return RetryDecision.retryDefault(sc);
               case ERROR:
                 return null;
               case OK:
                 return RetryDecision.abort();
               default:
                 throw new IllegalStateException(&quot;Unsupported &quot; + resp.getType());
             }
           }).withResultPartialPredicate((resp, sc)
           -&gt; (resp.getType() == Response.Type.ERROR)
           ? RetryDecision.retryDefault(sc)
           : RetryDecision.abort(), 3)
           .withExecutorService(es)
           .build().call(serverCall, IOException.class);
</pre></div></div>
</div>
<div class="section">
<h2><a name="Other_utilities"></a>Other utilities</h2>
<p>Lifo Threadpool: org.spf4j.concurrent.LifoThreadPoolBuilder</p>
<p>Retry utility implementation: see org.spf4j.base.Callables and org.spf4j.concurrent.RetryExecutor</p>
<p>Union: see org.spf4j.base.Either</p>
<p>Unique ID and Scalable sequence generators: org.spf4j.concurrent.UIDgenerator and org.spf4j.concurrent.ScalableSequence</p>
<p>Csv: org.spf4j.io.Csv, org.spf4j.avro.csv.CsvEncoder, org.spf4j.avro.csv.CsvDecoder</p>
<p>IPC: org.spf4j.concurrent.FileBasedLock</p>
<p>Data Structures: org.spf4j.ds.RTree; org.spf4j.ds.Graph; org.spf4j.ds.UpdateablePriorityQueue</p>
<p>Process control: org.spf4j.base.Runtime</p>
<p>Object recyclers: org.spf4j.recyclable.impl.*</p>
<p>Concurrency: org.spf4j.io.PipedOutputStream</p>
<p>String performance utilities: org.spf4j.base.Strings</p>
<p>NIO TCP proxy server: org.spf4j.io.tcp.proxy.*</p>
<p>Distributed semaphore: org.spf4j.concurrent.jdbc.JdbcSemaphore</p></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2021
<a href="http://www.spf4j.org">SPF4J</a>.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
