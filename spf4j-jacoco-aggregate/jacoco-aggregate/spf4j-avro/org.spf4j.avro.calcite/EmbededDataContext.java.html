<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>EmbededDataContext.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">spf4j-jacoco-aggregate</a> &gt; <a href="../index.html" class="el_bundle">spf4j-avro</a> &gt; <a href="index.source.html" class="el_package">org.spf4j.avro.calcite</a> &gt; <span class="el_source">EmbededDataContext.java</span></div><h1>EmbededDataContext.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2019 SPF4J.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.spf4j.avro.calcite;

import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import javax.annotation.Nullable;
import org.apache.avro.Schema;
import org.apache.calcite.DataContext;
import org.apache.calcite.adapter.java.JavaTypeFactory;
import org.apache.calcite.linq4j.QueryProvider;
import org.apache.calcite.schema.SchemaPlus;
import org.apache.calcite.tools.Frameworks;
import org.spf4j.avro.schema.Schemas;
import org.spf4j.security.AbacSecurityContext;

/**
 * @author Zoltan Farkas
 */
@SuppressFBWarnings(&quot;STT_TOSTRING_MAP_KEYING&quot;)
public final class EmbededDataContext implements DataContext {

  public static final String DEPRECATIONS = &quot;deprecated-access&quot;;

  public static final String SECURITY_CONTEXT = &quot;security-context&quot;;


  public static void addDeprecations(final Schema schema,
          final DataContext ctx) {
<span class="nc" id="L46">    final Map&lt;String, String&gt; deprecations = new HashMap&lt;&gt;(4);</span>
<span class="nc" id="L47">    Schemas.deprecations(schema, deprecations::put);</span>
<span class="nc" id="L48">    addDeprecations(schema.getFullName(), deprecations, ctx);</span>
<span class="nc" id="L49">  }</span>

  public static void addDeprecations(final String schemaName, final Map&lt;String, String&gt; deprecations,
          final DataContext ctx) {
<span class="nc bnc" id="L53" title="All 2 branches missed.">    if (deprecations.isEmpty()) {</span>
<span class="nc" id="L54">      return;</span>
    }
<span class="nc" id="L56">    Map&lt;String, String&gt; depr = (Map&lt;String, String&gt;) ctx.get(DEPRECATIONS);</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">    if (depr == null) {</span>
<span class="nc" id="L58">      return;</span>
    }
<span class="nc bnc" id="L60" title="All 2 branches missed.">    for (Map.Entry&lt;String, String&gt; entry : deprecations.entrySet()) {</span>
<span class="nc" id="L61">      depr.put(schemaName + '.' + entry.getKey(), entry.getValue());</span>
<span class="nc" id="L62">    }</span>
<span class="nc" id="L63">  }</span>

  private final JavaTypeFactory typeFact;

  private final ConcurrentMap&lt;String, Object&gt; data;

<span class="fc" id="L69">  public EmbededDataContext(final JavaTypeFactory typeFact, @Nullable final AbacSecurityContext ctx) {</span>
<span class="fc" id="L70">    this.typeFact = typeFact;</span>
<span class="fc" id="L71">    this.data = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L72">    this.data.put(DEPRECATIONS, new HashMap&lt;Object, Object&gt;(4));</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">    if (ctx != null) {</span>
<span class="nc" id="L74">      this.data.put(SECURITY_CONTEXT, ctx);</span>
    }
<span class="fc" id="L76">  }</span>

  public SchemaPlus getRootSchema() {
<span class="nc" id="L79">    return Frameworks.createRootSchema(true);</span>
  }

  public JavaTypeFactory getTypeFactory() {
<span class="fc" id="L83">    return (JavaTypeFactory) typeFact;</span>
  }

  public QueryProvider getQueryProvider() {
<span class="nc" id="L87">    return null;</span>
  }

  public Object get(final String name) {
<span class="fc" id="L91">    return data.get(name);</span>
  }

  public Object put(final String name, final Object value) {
<span class="nc" id="L95">    return data.put(name, value);</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L100">    return &quot;EmbededDataContext{&quot; + &quot;typeFact=&quot; + typeFact + '}';</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>