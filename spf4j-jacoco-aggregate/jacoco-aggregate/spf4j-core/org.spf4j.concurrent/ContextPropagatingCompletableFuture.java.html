<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ContextPropagatingCompletableFuture.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">spf4j-jacoco-aggregate</a> &gt; <a href="../index.html" class="el_bundle">spf4j-core</a> &gt; <a href="index.source.html" class="el_package">org.spf4j.concurrent</a> &gt; <span class="el_source">ContextPropagatingCompletableFuture.java</span></div><h1>ContextPropagatingCompletableFuture.java</h1><pre class="source lang-java linenums">package org.spf4j.concurrent;

import com.google.common.annotations.Beta;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import java.lang.reflect.InvocationTargetException;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.Executor;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;
import java.util.function.BiConsumer;
import java.util.function.BiFunction;
import java.util.function.Consumer;
import java.util.function.Function;
import java.util.function.Supplier;
import javax.annotation.Nullable;
import javax.annotation.ParametersAreNonnullByDefault;
import org.spf4j.base.ExecutionContext;
import org.spf4j.base.ExecutionContexts;
import org.spf4j.base.TimeSource;
import org.spf4j.base.Timing;
import org.spf4j.base.UncheckedTimeoutException;

/**
 * A Completable future that will wrap all Functions to properly propagate ExecutionContext.
 * see CompletableFuture javadoc for more detail.
 *
 * This works properly only in JDK 11.
 *
 * @author Zoltan Farkas
 */
@SuppressWarnings(&quot;checkstyle:DesignForExtension&quot;)
@Beta
@ParametersAreNonnullByDefault
public class ContextPropagatingCompletableFuture&lt;T&gt;
        extends InterruptibleCompletableFuture&lt;T&gt; {

  private final ExecutionContext parentContext;

  private final long deadlinenanos;

  @SuppressFBWarnings(&quot;EI_EXPOSE_REP2&quot;)
<span class="fc" id="L44">  public ContextPropagatingCompletableFuture(final ExecutionContext parentContext, final long deadlinenanos) {</span>
<span class="fc" id="L45">    this.parentContext = parentContext;</span>
<span class="fc" id="L46">    this.deadlinenanos = deadlinenanos;</span>
<span class="fc" id="L47">  }</span>



  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenApply(final Function&lt;? super T, ? extends U&gt; fn) {
<span class="nc" id="L53">    return super.thenApply(ExecutionContexts.propagatingFunction(fn, parentContext,</span>
            null, deadlinenanos));
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync(final Function&lt;? super T, ? extends U&gt; fn) {
<span class="nc" id="L59">    return super.thenApplyAsync(ExecutionContexts.propagatingFunction(fn, parentContext,</span>
            null, deadlinenanos));
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync(final Function&lt;? super T, ? extends U&gt; fn, final Executor executor) {
<span class="nc" id="L65">    return super.thenApplyAsync(ExecutionContexts.propagatingFunction(fn, parentContext,</span>
            null, deadlinenanos), executor);
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenAccept(final Consumer&lt;? super T&gt; action) {
<span class="nc" id="L71">    return super.thenAccept(ExecutionContexts.propagatingConsumer(action,</span>
            parentContext, null, deadlinenanos));
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenAcceptAsync(final Consumer&lt;? super T&gt; action) {
<span class="nc" id="L77">    return super.thenAcceptAsync(ExecutionContexts.propagatingConsumer(action,</span>
            parentContext, null, deadlinenanos));
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenAcceptAsync(final Consumer&lt;? super T&gt; action, final Executor executor) {
<span class="nc" id="L83">    return super.thenAcceptAsync(ExecutionContexts.propagatingConsumer(action,</span>
            parentContext, null, deadlinenanos), executor);
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenRun(final Runnable action) {
<span class="nc" id="L89">    return super.thenRun(ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenRunAsync(final Runnable action) {
<span class="nc" id="L94">    return super.thenRunAsync(</span>
<span class="nc" id="L95">            ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenRunAsync(final Runnable action, final Executor executor) {
<span class="nc" id="L100">    return super.thenRunAsync(</span>
<span class="nc" id="L101">                    ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public &lt;U, V&gt; CompletableFuture&lt;V&gt; thenCombine(final CompletionStage&lt;? extends U&gt; other,
          final BiFunction&lt;? super T, ? super U, ? extends V&gt; fn) {
<span class="nc" id="L107">    return super.thenCombine(other,</span>
<span class="nc" id="L108">            ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U, V&gt; CompletableFuture&lt;V&gt; thenCombineAsync(final CompletionStage&lt;? extends U&gt; other,
          final BiFunction&lt;? super T, ? super U, ? extends V&gt; fn) {
<span class="nc" id="L114">    return super.thenCombineAsync(other,</span>
<span class="nc" id="L115">            ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U, V&gt; CompletableFuture&lt;V&gt; thenCombineAsync(final CompletionStage&lt;? extends U&gt; other,
          final BiFunction&lt;? super T, ? super U, ? extends V&gt; fn, final Executor executor) {
<span class="nc" id="L121">    return super.thenCombineAsync(other,</span>
<span class="nc" id="L122">                    ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos),</span>
                    executor);
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;Void&gt; thenAcceptBoth(final CompletionStage&lt;? extends U&gt; other,
          final BiConsumer&lt;? super T, ? super U&gt; action) {
<span class="nc" id="L129">    return super.thenAcceptBoth(other, ExecutionContexts.propagatingBiConsumer(action, parentContext,</span>
                    null, deadlinenanos));
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;Void&gt; thenAcceptBothAsync(final CompletionStage&lt;? extends U&gt; other,
          final BiConsumer&lt;? super T, ? super U&gt; action) {
<span class="nc" id="L136">    return super.thenAcceptBothAsync(other,</span>
<span class="nc" id="L137">            ExecutionContexts.propagatingBiConsumer(action, parentContext,</span>
                    null, deadlinenanos));
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;Void&gt; thenAcceptBothAsync(final CompletionStage&lt;? extends U&gt; other,
          final BiConsumer&lt;? super T, ? super U&gt; action, final Executor executor) {
<span class="nc" id="L144">    return super.thenAcceptBothAsync(other,</span>
<span class="nc" id="L145">            ExecutionContexts.propagatingBiConsumer(action, parentContext,</span>
                    null, deadlinenanos), executor);
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterBoth(final CompletionStage&lt;?&gt; other, final Runnable action) {
<span class="nc" id="L151">    return super.runAfterBoth(other,</span>
<span class="nc" id="L152">            ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterBothAsync(final CompletionStage&lt;?&gt; other, final Runnable action) {
<span class="nc" id="L157">    return super.runAfterBothAsync(other, ExecutionContexts.propagatingRunnable(action, parentContext,</span>
            null, deadlinenanos));
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterBothAsync(final CompletionStage&lt;?&gt; other,
          final Runnable action, final Executor executor) {
<span class="nc" id="L164">    return super.runAfterBothAsync(other, ExecutionContexts.propagatingRunnable(action, parentContext,</span>
            null, deadlinenanos), executor);
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; applyToEither(final CompletionStage&lt;? extends T&gt; other,
          final Function&lt;? super T, U&gt; fn) {
<span class="nc" id="L171">    return super.applyToEither(other,</span>
<span class="nc" id="L172">                    ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; applyToEitherAsync(final CompletionStage&lt;? extends T&gt; other,
          final Function&lt;? super T, U&gt; fn) {
<span class="nc" id="L178">    return super.applyToEitherAsync(other,</span>
<span class="nc" id="L179">            ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; applyToEitherAsync(final CompletionStage&lt;? extends T&gt; other,
          final Function&lt;? super T, U&gt; fn, final Executor executor) {
<span class="nc" id="L185">    return super.applyToEitherAsync(other,</span>
<span class="nc" id="L186">            ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; acceptEither(final CompletionStage&lt;? extends T&gt; other,
          final Consumer&lt;? super T&gt; action) {
<span class="nc" id="L192">    return super.acceptEither(other,</span>
<span class="nc" id="L193">            ExecutionContexts.propagatingConsumer(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; acceptEitherAsync(final CompletionStage&lt;? extends T&gt; other,
          final Consumer&lt;? super T&gt; action) {
<span class="nc" id="L199">    return super.acceptEitherAsync(other,</span>
<span class="nc" id="L200">            ExecutionContexts.propagatingConsumer(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; acceptEitherAsync(final CompletionStage&lt;? extends T&gt; other,
          final Consumer&lt;? super T&gt; action, final Executor executor) {
<span class="nc" id="L206">    return super.acceptEitherAsync(other,</span>
<span class="nc" id="L207">            ExecutionContexts.propagatingConsumer(action, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterEither(final CompletionStage&lt;?&gt; other, final Runnable action) {
<span class="nc" id="L212">    return super.runAfterEither(other,</span>
<span class="nc" id="L213">            ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterEitherAsync(final CompletionStage&lt;?&gt; other, final Runnable action) {
<span class="nc" id="L218">    return super.runAfterEitherAsync(other,</span>
<span class="nc" id="L219">            ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterEitherAsync(final CompletionStage&lt;?&gt; other,
          final Runnable action, final Executor executor) {
<span class="nc" id="L225">    return super.runAfterEitherAsync(other,</span>
<span class="nc" id="L226">            ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenCompose(final Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn) {
<span class="nc" id="L231">    return super.thenCompose(ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenComposeAsync(final Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn) {
<span class="nc" id="L236">    return super.thenComposeAsync(ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenComposeAsync(final Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn,
          final Executor executor) {
<span class="nc" id="L242">    return super.thenComposeAsync(</span>
<span class="nc" id="L243">            ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public CompletableFuture&lt;T&gt; exceptionally(final Function&lt;Throwable, ? extends T&gt; fn) {
<span class="nc" id="L248">    return super.exceptionally(ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;T&gt; whenComplete(final BiConsumer&lt;? super T, ? super Throwable&gt; action) {
<span class="fc" id="L253">    return super.whenComplete(ExecutionContexts.propagatingBiConsumer(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;T&gt; whenCompleteAsync(final BiConsumer&lt;? super T, ? super Throwable&gt; action) {
<span class="nc" id="L258">    return super.whenCompleteAsync(</span>
<span class="nc" id="L259">            ExecutionContexts.propagatingBiConsumer(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;T&gt; whenCompleteAsync(final BiConsumer&lt;? super T, ? super Throwable&gt; action,
          final Executor executor) {
<span class="nc" id="L265">    return super.whenCompleteAsync(</span>
<span class="nc" id="L266">            ExecutionContexts.propagatingBiConsumer(action, parentContext, null, deadlinenanos),</span>
            executor);
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; handle(final BiFunction&lt;? super T, Throwable, ? extends U&gt; fn) {
<span class="nc" id="L272">    return super.handle(ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; handleAsync(final BiFunction&lt;? super T, Throwable, ? extends U&gt; fn) {
<span class="nc" id="L277">    return super.handleAsync(</span>
<span class="nc" id="L278">            ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; handleAsync(final BiFunction&lt;? super T, Throwable, ? extends U&gt; fn,
          final Executor executor) {
<span class="nc" id="L284">    return super.handleAsync(</span>
<span class="nc" id="L285">            ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public CompletableFuture&lt;T&gt; toCompletableFuture() {
<span class="nc" id="L290">    return this;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L295">    return &quot;ContextPropagatingCompletableFuture{&quot; + &quot;parentContext=&quot; + parentContext</span>
<span class="nc" id="L296">            + &quot;, deadlinenanos=&quot; + deadlinenanos + &quot;, super=&quot; + super.toString() +  '}';</span>
  }

  @Override
  @Nullable
  public T get() throws InterruptedException, ExecutionException {
    try {
<span class="fc" id="L303">      long timeout = deadlinenanos - TimeSource.nanoTime();</span>
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">      if (timeout &lt; 0) {</span>
<span class="nc" id="L305">        throw new UncheckedTimeoutException(&quot;deadline exceeded &quot; + Timing.getCurrentTiming()</span>
<span class="nc" id="L306">                .fromNanoTimeToInstant(deadlinenanos));</span>
      }
<span class="fc" id="L308">      return super.get(timeout, TimeUnit.NANOSECONDS);</span>
<span class="nc" id="L309">    } catch (TimeoutException ex) {</span>
<span class="nc" id="L310">      throw new UncheckedTimeoutException(ex);</span>
    }
  }


  /**
   * JDK 11.
   */
  public CompletableFuture&lt;T&gt; completeAsync(final Supplier&lt;? extends T&gt; supplier) {
    try {
<span class="nc" id="L320">      return (CompletableFuture)</span>
<span class="nc" id="L321">              this.getClass().getMethod(&quot;completeAsync&quot;, new Class[] {Supplier.class})</span>
<span class="nc" id="L322">                .invoke(this, ExecutionContexts.propagatingSupplier(supplier, parentContext, null, deadlinenanos));</span>
<span class="nc" id="L323">    } catch (NoSuchMethodException | SecurityException | IllegalAccessException | InvocationTargetException ex) {</span>
<span class="nc" id="L324">      throw new UnsupportedOperationException(&quot;Supported only on JDK 11&quot;, ex);</span>
    }
  }

  /**
   * JDK 11.
   */
  public CompletableFuture&lt;T&gt; completeAsync(final Supplier&lt;? extends T&gt; supplier, final Executor executor) {
    try {
<span class="nc" id="L333">      return (CompletableFuture)</span>
<span class="nc" id="L334">              this.getClass().getMethod(&quot;completeAsync&quot;, new Class[] {Supplier.class, Executor.class})</span>
<span class="nc" id="L335">                      .invoke(this,</span>
<span class="nc" id="L336">                              ExecutionContexts.propagatingSupplier(supplier, parentContext, null, deadlinenanos),</span>
                              executor);
<span class="nc" id="L338">    } catch (NoSuchMethodException | SecurityException | IllegalAccessException | InvocationTargetException ex) {</span>
<span class="nc" id="L339">      throw new UnsupportedOperationException(&quot;Supported only on JDK 11&quot;, ex);</span>
    }
  }

  /**
   * JDK 11!
   */
  public &lt;U&gt; CompletableFuture&lt;U&gt; newIncompleteFuture() {
<span class="nc" id="L347">    return new ContextPropagatingCompletableFuture&lt;&gt;(parentContext, deadlinenanos);</span>
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(final Supplier&lt;U&gt; f) {
<span class="nc" id="L351">    return supplyAsync(f, DefaultExecutor.INSTANCE);</span>
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(final Supplier&lt;U&gt; f, final Executor e) {
<span class="fc" id="L355">    ExecutionContext current = ExecutionContexts.current();</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">    if (current == null) {</span>
<span class="nc" id="L357">      return CompletableFuture.supplyAsync(f, e);</span>
    }
<span class="fc" id="L359">    return supplyAsync(f, current, e, current.getDeadlineNanos());</span>
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(
          final Supplier&lt;U&gt; f, final Executor e, final long deadlineNanos) {
<span class="nc" id="L364">    ExecutionContext current = ExecutionContexts.current();</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">    if (current == null) {</span>
<span class="nc" id="L366">      return CompletableFuture.supplyAsync(f, e);</span>
    }
<span class="nc" id="L368">    return supplyAsync(f, current, e, deadlineNanos);</span>
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(final Supplier&lt;U&gt; f,
          final ExecutionContext current,
          final Executor e, final long deadlineNanos) {
<span class="fc" id="L374">    long ctxDeadlineNanos = current.getDeadlineNanos();</span>
<span class="fc" id="L375">    long currentTime = TimeSource.nanoTime();</span>
    long effectiveDeadlineNanos;
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">    if ((ctxDeadlineNanos - currentTime) &gt; (deadlineNanos - currentTime)) {</span>
<span class="nc" id="L378">      effectiveDeadlineNanos = deadlineNanos;</span>
    } else {
<span class="fc" id="L380">      effectiveDeadlineNanos = ctxDeadlineNanos;</span>
    }
<span class="fc" id="L382">    ContextPropagatingCompletableFuture&lt;U&gt; d</span>
            = new ContextPropagatingCompletableFuture&lt;U&gt;(current, effectiveDeadlineNanos);
<span class="fc" id="L384">    e.execute(() -&gt; {</span>
      try {
        U r;
<span class="fc" id="L387">        try (ExecutionContext ec = ExecutionContexts.start(f.toString(), current,</span>
                currentTime, effectiveDeadlineNanos)) {
<span class="fc" id="L389">          r = f.get();</span>
        }
<span class="fc" id="L391">        d.complete(r);</span>
<span class="nc" id="L392">      } catch (Throwable t) {</span>
<span class="nc" id="L393">        d.completeExceptionally(t);</span>
<span class="fc" id="L394">      }</span>
<span class="fc" id="L395">    });</span>
<span class="fc" id="L396">    return d;</span>
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; completedFuture(final U value) {
<span class="nc" id="L400">    ExecutionContext current = ExecutionContexts.current();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">    if (current == null) {</span>
<span class="nc" id="L402">      return CompletableFuture.completedFuture(value);</span>
    } else {
<span class="nc" id="L404">      return completedFuture(current, current.getDeadlineNanos(), value);</span>
    }
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; completedFuture(
          final ExecutionContext parentContext, final long deadlinenanos, final U value) {
<span class="nc" id="L410">    ContextPropagatingCompletableFuture&lt;U&gt; r = new ContextPropagatingCompletableFuture&lt;U&gt;(parentContext, deadlinenanos);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">    if (!r.complete(value)) {</span>
<span class="nc" id="L412">      throw new IllegalStateException(&quot;Cannot be already completed &quot; + r);</span>
    }
<span class="nc" id="L414">    return r;</span>
  }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>