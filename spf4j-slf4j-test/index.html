<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/markdown/index.md at 2021-11-10
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20211110" />
    <meta http-equiv="Content-Language" content="en" />
    <title>spf4j-slf4j-test &#x2013; spf4j-slf4j-test the module that allows you to leverage logging in unit tests.</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script type="text/javascript" src="./js/apache-maven-fluido-1.7.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>SPF4J</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2021-11-10<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 8.9.3-SNAPSHOT</li>
      <li class="pull-right"><a href=".." title="SPF4J">SPF4J</a></li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">Main Menu</li>
    <li class="active"><a href="#"><span class="none"></span>Introduction</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-down"></span>Project Information</a>
    <ul class="nav nav-list">
    <li><a href="integration.html" title="Continuous Integration"><span class="none"></span>Continuous Integration</a></li>
    <li><a href="dependencies.html" title="Dependencies"><span class="none"></span>Dependencies</a></li>
    <li><a href="dependency-info.html" title="Dependency Information"><span class="none"></span>Dependency Information</a></li>
    <li><a href="dependency-management.html" title="Dependency Management"><span class="none"></span>Dependency Management</a></li>
    <li><a href="distribution-management.html" title="Distribution Management"><span class="none"></span>Distribution Management</a></li>
    <li class="active"><a href="#"><span class="none"></span>About</a></li>
    <li><a href="issue-tracking.html" title="Issue Tracking"><span class="none"></span>Issue Tracking</a></li>
    <li><a href="license.html" title="Project License"><span class="none"></span>Project License</a></li>
    <li><a href="mail-lists.html" title="Mailing Lists"><span class="none"></span>Mailing Lists</a></li>
    <li><a href="plugin-management.html" title="Plugin Management"><span class="none"></span>Plugin Management</a></li>
    <li><a href="plugins.html" title="Project Plugins"><span class="none"></span>Project Plugins</a></li>
    <li><a href="team-list.html" title="Project Team"><span class="none"></span>Project Team</a></li>
    <li><a href="source-repository.html" title="Source Repository"><span class="none"></span>Source Repository</a></li>
    <li><a href="project-summary.html" title="Project Summary"><span class="none"></span>Project Summary</a></li>
    </ul>
</li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>spf4j-slf4j-test the module that allows you to leverage logging in unit tests.</h1>
<div class="section">
<h2><a name="a1._Overview"></a>1. Overview</h2>
<p>The spf4j-slf4j-test module is a backend implementation for the slf4j api.</p>
<p>This is an opinionated logging backend implementation for testing(junit) with the following features:</p>
<ul>

<li>Ability to assert Logging behavior.</li>
<li>Readable and parse-able output.</li>
<li>Fail unit tests that log an Error by default (if respective Error logs are not asserted against). (similar to the junit default of failing on exception by default)</li>
<li>Make debug logs available on unit test failure. This helps performance a lot by not requiring you to run your unit tests with tons of debug info dumped to output all the time. But making it available when you actually need it (Unit test failure)</li>
<li>Easily change logging configuration via API.</li>
<li>Uncaught exceptions from other threads will fail your tests. You can assert them if they are expected.</li>
<li>No configurable format, It is the best format so everybody should be using it. Format will be evolved as needed.</li>
<li>Ability to log other object payload additionally to the log message.</li>
<li>Type level String image customization. (if unhappy with default toString, json format is desired, or performance optimization is desired)</li>
<li>Fast. (logging is no reason to have slow builds)</li>
<li>Lossless and fast java.util.logging redirect. (source class, source method &#x2026; are not being lost)</li>
<li>Environment specific configurations with best defaults right out of the box. (DEBUG when running from IDE, INFO otherwise)</li>
<li>Assert logging made from various logging APIs. java.util.logging supported out of the box, for everything else <a class="externalLink" href="https://www.slf4j.org/legacy.html">see</a></li>
<li>Ability to control your timing based on TimeSource.</li>
<li>Dump thread states when unit test does not finish after a default timeout (spf4j.test.log.defaultTestTimeoutMillis=120000ms)</li>
</ul></div>
<div class="section">
<h2><a name="a2._How_to_use_it."></a>2. How to use it.</h2>
<div class="section">
<h3><a name="Pom_changes:"></a>Pom changes:</h3>
<p>Add to your pom.xml dependency section (make sure it is ahead of other slf4j backends you might have in your classpath):</p>

<div>
<div>
<pre class="source">&lt;dependency&gt;
  &lt;groupId&gt;org.spf4j&lt;/groupId&gt;
  &lt;artifactId&gt;spf4j-slf4j-test&lt;/artifactId&gt;
  &lt;scope&gt;test&lt;/scope&gt;
  &lt;version&gt;LATEST&lt;/version&gt;
&lt;/dependency&gt;
</pre></div></div>

<p>Register the junit runListener in your surefire plugin config:</p>

<div>
<div>
<pre class="source">  &lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
    &lt;configuration&gt;
      &lt;properties&gt;
        &lt;property&gt;
          &lt;name&gt;listener&lt;/name&gt;
          &lt;value&gt;org.spf4j.test.log.junit4.Spf4jTestLogRunListener&lt;/value&gt; &lt;!-- comma separate multiple listeners --&gt;
        &lt;/property&gt;
      &lt;/properties&gt;
    &lt;/configuration&gt;
  &lt;/plugin&gt;
</pre></div></div>

<p>Or if your IDE is not smart enough (you InteliJ and Eclipse) to pick the run listeners up from your pom.xml, you can use the Spf4jTestLogJUnitRunner in conjunction junit @RunWith annotation. If you have CustomClassRunners already, you can easily upgrade them to register Spf4jTestLogRunListener as done in Spf4jTestLogJUnitRunner.</p>
<p>NOTE: since logging is JVM global, you should run your unit tests single threaded to be able to easily reason about your logging, and more accurate log message attribution.</p>
<p>When using junit 5 you will need to use:</p>

<div>
<div>
<pre class="source">  &lt;dependency&gt;
    &lt;groupId&gt;org.spf4j&lt;/groupId&gt;
    &lt;artifactId&gt;spf4j-slf4j-test-junit5&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
    &lt;version&gt;LATEST&lt;/version&gt;
  &lt;/dependency&gt;
</pre></div></div>

<p>you will not need to manually specify the listener, this will happen automatically through the ServiceLoader mechanism.</p></div>
<div class="section">
<h3><a name="JDK_9.2B_notes"></a>JDK 9+ notes</h3>
<p>When running on java 9 or higher you will receive warnings like:</p>

<div>
<div>
<pre class="source">WARNING: Illegal reflective access by  ...
</pre></div></div>

<p>you can remove these warnings by adding to you java command line:</p>

<div>
<div>
<pre class="source">--add-opens=java.logging/java.util.logging=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED
</pre></div></div>
</div>
<div class="section">
<h3><a name="Examples:"></a>Examples:</h3>
<div class="section">
<h4><a name="Assert_that_you_expect_message_to_be_logged:"></a>Assert that you expect message to be logged:</h4>

<div>
<div>
<pre class="source">  LogAssert expect = TestLoggers.sys().expect(&quot;org.spf4j.test&quot;, Level.ERROR,
            LogMatchers.hasFormat(&quot;Booo&quot;));
  LOG.error(&quot;Booo&quot;, new RuntimeException());
  expect.assertObservation(); // whithout assert the unit test fails when logging an error.
</pre></div></div>
</div>
<div class="section">
<h4><a name="Assert_that_you_expect_a_log_message_with_annotations:"></a>Assert that you expect a log message with annotations:</h4>

<div>
<div>
<pre class="source">  @Test
  @ExpectLog(level = Level.ERROR)
  public void testLoggingAnnot() {
    LOG.error(&quot;Booo&quot;, new RuntimeException());
  }
</pre></div></div>
</div>
<div class="section">
<h4><a name="Assert_that_you_expect_message_to_be_logged_asynchronously:"></a>Assert that you expect message to be logged asynchronously:</h4>

<div>
<div>
<pre class="source">  LogAssert expect = TestLoggers.sys().expect(&quot;org.spf4j.test.log&quot;, Level.ERROR,
                                               3, TimeUnit.SECONDS LogMatchers.hasFormat(&quot;async&quot;));
  new Thread(() -&gt; {
    LOG.error(&quot;async&quot;);
  }).start();
  expect.assertObservation();
</pre></div></div>
</div>
<div class="section">
<h4><a name="Assert_uncaught_exceptions:"></a>Assert uncaught exceptions:</h4>

<div>
<div>
<pre class="source">  AsyncObservationAssert obs = TestLoggers.sys().expectUncaughtException(5, TimeUnit.SECONDS,
                                    Matchers.hasProperty(&quot;throwable&quot;,
                                          Matchers.any(IllegalStateException.class)));
  executor.execute(new Runnable() {

    @Override
    public void run() {
      throw new IllegalStateException(&quot;Yohoo&quot;);
    }
  });
  obs.assertObservation(5, TimeUnit.SECONDS);
</pre></div></div>
</div>
<div class="section">
<h4><a name="Collect_LogRecords:"></a>Collect LogRecords:</h4>

<div>
<div>
<pre class="source">try (LogCollection&lt;Long&gt; c = TestLoggers.sys().collect(&quot;org.spf4j.test&quot;, Level.INFO, true, Collectors.counting())) {
  LOG.info(&quot;m1&quot;);
  LOG.info(&quot;m2&quot;);
  Assert.assertEquals(2L, (long) c.get());
}
</pre></div></div>
</div>
<div class="section">
<h4><a name="Change_LOG_print_config_for_a_log_category_for_a_code_section_with_API:"></a>Change LOG print config for a log category for a code section with API:</h4>

<div>
<div>
<pre class="source">  try (HandlerRegistration printer = TestLoggers.sys().print(&quot;my.log.package&quot;, Level.TRACE)) {
    ...
    LOG.error(&quot;Booo&quot;, new RuntimeException());
    ..
  }
</pre></div></div>

<p>or for a unit test:</p>

<div>
<div>
<pre class="source">@Test
@PrintLogs(category = &quot;org.spf4&quot;, ideMinLevel = Level.TRACE)
public void testSomeHandler2() {
  ....
  LOG.trace(&quot;test&quot;);
  ....
}
</pre></div></div>

<p>or a more complex print config:</p>

<div>
<div>
<pre class="source">  @Test
  @PrintLogsConfigs(
          {
            @PrintLogs(ideMinLevel = Level.TRACE),
            @PrintLogs(category = &quot;com.sun&quot;, ideMinLevel = Level.WARN)
          }
  )
  public void testLogging() {
     ....
</pre></div></div>
</div>
<div class="section">
<h4><a name="Log_Additional_objects:"></a>Log Additional objects:</h4>

<div>
<div>
<pre class="source">  LOG.debug(&quot;log {} {} {}&quot;, 1, 2, 3, /* extra object */ 4);
</pre></div></div>

<p>will be logged as:</p>

<div>
<div>
<pre class="source">  09:23:32.731 DEBUG o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;log 1 2 3&quot; [&quot;4&quot;]
</pre></div></div>
</div>
<div class="section">
<h4><a name="Customize_String_image_that_is_logged."></a>Customize String image that is logged.</h4>
<p>If your objects implement JsonWriteable or you register a Json serializer for a particular type like:</p>

<div>
<div>
<pre class="source">   LogPrinter.getAppenderSupplier().register(TestLoggerFactoryTest.class,
        MimeTypes.APPLICATION_JSON, (o, a) -&gt; {a.append(&quot;{\&quot;a\&quot; : \&quot;b\&quot;}&quot;);});
   LOG.info(&quot;Json Payload&quot;, this); // this will be not part of the messages string and will be logged as extra payload
</pre></div></div>

<p>will be logged like:</p>

<div>
<div>
<pre class="source">   12:13:00.656 INFO o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;Json Payload&quot; [{&quot;a&quot; : &quot;b&quot;}]
</pre></div></div>
</div>
<div class="section">
<h4><a name="Debug_detail_on_demand."></a>Debug detail on demand.</h4>
<p>For example if you have spf4j.test.log.rootPrintLevel=DEBUG and you want everything above trace available if a unit test fails, you can either set globaly spf4j.test.log.collectMinLevel=TRACE or you can control this at test level like:</p>

<div>
<div>
<pre class="source">  @Test
  @CollectLogs(minLevel = Level.TRACE)
  public void testLogging4() {
    LOG.trace(&quot;lala&quot;);
    LOG.debug(&quot;log {}&quot;, 1);
    LOG.debug(&quot;log {} {}&quot;, 1, 2);
    LOG.debug(&quot;log {} {} {}&quot;, 1, 2, 3);
    LOG.debug(&quot;log {} {} {}&quot;, 1, 2, 3, 4);
    Assert.fail(&quot;booo&quot;);
  }
</pre></div></div>

<p>Will result in the following output:</p>

<div>
<div>
<pre class="source">  Running org.spf4j.test.log.TestLoggerFactoryTest
  09:23:32.691 DEBUG o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;log 1&quot;
  09:23:32.731 DEBUG o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;log 1 2&quot;
  09:23:32.731 DEBUG o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;log 1 2 3&quot;
  09:23:32.731 DEBUG o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;log 1 2 3&quot; [&quot;4&quot;]
  09:23:32.759 INFO o.s.t.l.j.Spf4jTestLogRunListenerSingleton &quot;main&quot; &quot;Dumping last 100 unprinted logs for testLogging4(org.spf4j.test.log.TestLoggerFactoryTest)&quot;
  09:23:32.691 TRACE o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;lala&quot;
  09:23:32.759 INFO o.s.t.l.j.Spf4jTestLogRunListenerSingleton &quot;main&quot; &quot;End dump for testLogging4(org.spf4j.test.log.TestLoggerFactoryTest)&quot;
  testLogging4(org.spf4j.test.log.TestLoggerFactoryTest)  Time elapsed: 0.054 s  &lt;&lt;&lt; FAILURE!
  java.lang.AssertionError: booo
          at org.junit.Assert.fail(Assert.java:88)
          at org.spf4j.test.log.TestLoggerFactoryTest.testLogging4(TestLoggerFactoryTest.java:200)
          at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
          at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
</pre></div></div>
</div>
<div class="section">
<h4><a name="Available_global_configuration_system_properties_with_the_defaults:"></a>Available global configuration system properties with the defaults:</h4>

<div>
<div>
<pre class="source">  # default root log level when tests executed from IDE. see TestUtils.class for more info.
  spf4j.test.log.rootPrintLevelIDE = DEBUG
  # default root log level.
  spf4j.test.log.rootPrintLevel = INFO
  # default log level collected for availability when a unit test fails.
  spf4j.test.log.collectMinLevel = DEBUG
  # maximum number of logs to collect for availability in case of a failure. (by default only unprinted logs are collected)
  spf4j.test.log.collectmaxLogs = 100
  # collect printed logs.
  spf4j.test.log.collectPrintedLogs
  # loggers where ERROR should not fail your unit tests. (comma separated)
  spf4j.test.log.expectingErrorsIn
</pre></div></div>
</div>
<div class="section">
<h4><a name="Configuring_the_default_log_printing_configuration."></a>Configuring the default log printing configuration.</h4>
<p>You can add to your test resources a file with the name spf4j-test-prtcfg.properties or spf4j-test-prtcfg-ide.properties if you want different configuration when executing your tests from the IDE. The file format is a property file with key=values in the format:</p>

<div>
<div>
<pre class="source">  [category(package) name]=[LOG_LEVEL](,[greedy])?
</pre></div></div>
</div>
<div class="section">
<h4><a name="Customized_timing_for_testing."></a>Customized timing for testing.</h4>
<p>You can control TimeSource like:</p>

<div>
<div>
<pre class="source">    @Test
    public void testAssertionError() {
      TestTimeSource.setTimeStream(0L, 1L, 2L);
      Assert.assertEquals(0L, TimeSource.nanoTime());
      Assert.assertEquals(1L, TimeSource.nanoTime());
      ....
</pre></div></div>
</div>
<div class="section">
<h4><a name="The_log_format_is:"></a>The log format is:</h4>

<div>
<div>
<pre class="source">  [ISO UTC Timestaamp] [LOG Level] [Markers(jsonstr/json obj)]? [LOGGER] [THREAD(jsonstr)] [MESSAGE(json str)] [Extra Objects(array&lt;json&gt;)]?
  [StackTrace]?
</pre></div></div>

<p>sample log messages:</p>

<div>
<div>
<pre class="source">  2018-01-25T19:55:06.080Z ERROR o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;Hello logger&quot;
  2018-01-25T19:55:06.081Z ERROR o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;Hello logger 1&quot;
  2018-01-25T19:55:06.081Z ERROR o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;Hello logger 1 2 3&quot;
  2018-01-25T19:55:06.081Z ERROR o.s.t.l.TestLoggerFactoryTest &quot;main&quot; &quot;Hello logger 1 2 3&quot; [&quot;4&quot;]
  java.lang.RuntimeException
          at o.s.t.l.TestLoggerFactoryTest.logMarkerTests(TestLoggerFactoryTest.java:116)[test-classes/]
          at ^.testLogging(^:43)[^]
          at s.r.NativeMethodAccessorImpl.invoke0(Native Method)[:1.8.0_162]
          at ^.invoke(^:62)[^]
          at s.r.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)[^]
          at j.l.r.Method.invoke(Method.java:498)[^]
          ...
</pre></div></div></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2021
<a href="http://www.spf4j.org">SPF4J</a>.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
