<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/markdown/metrics.md at 2021-11-10
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20211110" />
    <meta http-equiv="Content-Language" content="en" />
    <title>spf4j-8.9.3-SNAPSHOT &#x2013; Metrics</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script type="text/javascript" src="./js/apache-maven-fluido-1.7.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>SPF4J</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2021-11-10<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 8.9.3-SNAPSHOT</li>
      <li class="pull-right"><a href="./" title="SPF4J">SPF4J</a></li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">Main Menu</li>
    <li><a href="index.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="http://search.maven.org/#search|ga|1|spf4j" class="externalLink" title="Download"><span class="none"></span>Download</a></li>
      <li class="nav-header">Modules</li>
    <li><a href="spf4j-aether/index.html" title="spf4j-aether"><span class="none"></span>spf4j-aether</a></li>
    <li><a href="spf4j-asm/index.html" title="spf4j-asm"><span class="none"></span>spf4j-asm</a></li>
    <li><a href="spf4j-config-discovery-maven-plugin/index.html" title="spf4j-config-discovery-maven-plugin"><span class="none"></span>spf4j-config-discovery-maven-plugin</a></li>
    <li><a href="spf4j-jdiff-maven-plugin/index.html" title="spf4j-jdiff-maven-plugin"><span class="none"></span>spf4j-jdiff-maven-plugin</a></li>
    <li><a href="spf4j-core/index.html" title="spf4j-core"><span class="none"></span>spf4j-core</a></li>
    <li><a href="spf4j-slf4j-test/index.html" title="spf4j-slf4j-test"><span class="none"></span>spf4j-slf4j-test</a></li>
    <li><a href="spf4j-slf4j-test-junit5/index.html" title="spf4j-slf4j-test-junit5"><span class="none"></span>spf4j-slf4j-test-junit5</a></li>
    <li><a href="spf4j-joda/index.html" title="spf4j-joda"><span class="none"></span>spf4j-joda</a></li>
    <li><a href="spf4j-core-gwt/index.html" title="spf4j-core-gwt"><span class="none"></span>spf4j-core-gwt</a></li>
    <li><a href="spf4j-junit/index.html" title="spf4j-junit"><span class="none"></span>spf4j-junit</a></li>
    <li><a href="spf4j-jmh/index.html" title="spf4j-jmh"><span class="none"></span>spf4j-jmh</a></li>
    <li><a href="spf4j-jmh-11/index.html" title="spf4j-jmh-11"><span class="none"></span>spf4j-jmh-11</a></li>
    <li><a href="spf4j-ui/index.html" title="spf4j-ui"><span class="none"></span>spf4j-ui</a></li>
    <li><a href="spf4j-aspects/index.html" title="spf4j-aspects"><span class="none"></span>spf4j-aspects</a></li>
    <li><a href="spf4j-zel/index.html" title="spf4j-zel"><span class="none"></span>spf4j-zel</a></li>
    <li><a href="spf4j-zel-javax/index.html" title="spf4j-zel-javax"><span class="none"></span>spf4j-zel-javax</a></li>
    <li><a href="spf4j-avro-components/index.html" title="spf4j-avro-components"><span class="none"></span>spf4j-avro-components</a></li>
    <li><a href="spf4j-jacoco-aggregate/index.html" title="spf4j-jacoco-aggregate"><span class="none"></span>spf4j-jacoco-aggregate</a></li>
    <li><a href="spf4j-maven-schema-resolver/index.html" title="spf4j-maven-schema-resolver"><span class="none"></span>spf4j-maven-schema-resolver</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>Metrics</h1>
<div class="section">
<h2><a name="Overview"></a>Overview</h2>
<p>To reduce the observer effect <a class="externalLink" href="http://psy-lob-saw.blogspot.com/2013/06/java-concurrent-counters-by-numbers.html">Thread Local Counters</a> are being used along with a optimized avro based binary file format.</p>
<p>This is how it works:</p>
<p><img src="images/MetricsFlow.svg" alt="Metrics collection" /></p>
<p><a class="externalLink" href="https://zolyfarkas.github.io/core-schema/avrodoc.html#/schema/org.spf4j.tsdb2.avro.MeasurementType">See</a> for measurement types supported.</p></div>
<div class="section">
<h2><a name="How_to_record_measurements"></a>How to record measurements</h2>
<div class="section">
<h3><a name="Via_API"></a>Via API</h3>
<ul>

<li>Low impact with log linear quantized recording for Gauge type of measurements:</li>
</ul>

<div>
<div>
<pre class="source">private static final MeasurementRecorder recorder
                     = RecorderFactory.createScalableQuantizedRecorder(forWhat, unitOfMeasurement,
                     sampleTime, factor, lowerMagnitude, higherMagnitude, quantasPerMagnitude);
&#x2026;
recorder.record(measurement);
</pre></div></div>

<p>This is ideal for recording execution times and provides the most detail. (Min, max, avg, and detailed distribution heat chart) If distribution chart is not needed createScalableMinMaxAvgRecorder is available with less overhead.</p>
<ul>

<li>Low impact with simple counting for Counters.</li>
</ul>

<div>
<div>
<pre class="source">private static final MeasurementRecorder recorder
                     = RecorderFactory.createScalableCountingRecorder(forWhat, unitOfMeasurement, sampleTimeMillis);
&#x2026;
recorder.record(measurement);
</pre></div></div>

<div>
<div>
<pre class="source">This is ideal for measurements like bytesSent, bytesReceived.
</pre></div></div>

<ul>

<li>Dynamic with log linear quantized recording for Gauge type of measurements.</li>
</ul>

<div>
<div>
<pre class="source">private static final MeasurementRecorderSource recorderSource
                    = RecorderFactory.createScalableQuantizedRecorderSource( forWhatCategory, unitOfMeasurement,
                      sampleTime, factor, lowerMagnitude, higherMagnitude, quantasPerMagnitude);
&#x2026;
recorderSource.getRecorder(forWhat).record(measurement)
</pre></div></div>

<div>
<div>
<pre class="source">As with the low impact static recorders there are dynamic equivalents:
createScalableMinMaxAvgRecorderSource and createScalableCountingRecorderSource
</pre></div></div>

<p>You can also create a monitored callable and call it of pass it to a executor like :</p>

<div>
<div>
<pre class="source">Callable&lt;?&gt; monitoredCallable =
     performanceMonitoredCallable(recorderSource, warnMillis, errorMillis, callable, &quot;myCallable&quot;).call()
</pre></div></div>
</div>
<div class="section">
<h3><a name="Via_Annotations"></a>Via Annotations</h3>
<p>Annotate a method you want to measure and monitor performance with the annotation:</p>

<div>
<div>
<pre class="source">@PerformanceMonitor(warnThresholdMillis=1, errorThresholdMillis=100, recorderSource = RecorderSourceInstance.Rs5m.class)
</pre></div></div>

<p>Start your jvm with Aspectj(1.7.x if you use java 1.7 or 1.8.x if you use java 1.8) load time weaver:</p>

<div>
<div>
<pre class="source">-javaagent:${project.build.directory}/lib/aspectjweaver-${aspectj.version}.jar
</pre></div></div>

<p>Make sure your aspectj config file (META-INF/aop.xml) contains:</p>

<div>
<div>
<pre class="source">&lt;aspectj&gt;
&lt;aspects&gt;
&lt;aspect name=&quot;org.spf4j.perf.aspects.PerformanceMonitorAspect&quot;/&gt;
&lt;/aspects&gt;
&lt;weaver options=&quot;-verbose&quot;&gt;
    &lt;!-- make sure the classes you want to apply aspects to are included --&gt;
    &lt;include within=&quot;com..*&quot;/&gt;
    &lt;include within=&quot;org.spf4j.perf.aspects.PerformanceMonitorAspect&quot;/&gt;
&lt;/weaver&gt;
&lt;/aspectj&gt;
</pre></div></div>

<p>This will record the execution times of the annotated method, and will also log (via spf4j) a message containing the call detail and execution time if the warn or error thresholds are exceeded. Dynamic quantized recorder source is used.</p></div>
<div class="section">
<h3><a name="Where_are_measurements_stored.3F"></a>Where are measurements stored?</h3>
<p>You can configure where the measurements are stored via the &#x201c;spf4j.perf.ms.config&#x201d; system property like:</p>

<div>
<div>
<pre class="source">  -Dspf4j.perf.ms.config=TSDB@/path/to/file.tsdb,TSDB_TXT@/path/to/file.tsdbtxt,GRAPHITE_UDP@1.1.1.1:8080,GRAPHITE_TCP@1.1.1.1:8080
</pre></div></div>

<p>TSDB_AVRO (DEFAULT) - standard avro files, metrics will be stored to  *.tabledef.avro (metadata) and *.observation.avro (obsevations)</p>
<p>TSDB - binary file format (this is the most efficient store)</p>
<p>TSDB_TXT - text format each line: groupname, timestamp millis, sampletime millis, measurementName1, measurementValue2, &#x2026;</p>
<p>GRAPHITE_UDP - Graphite UDP appender.</p>
<p>GRAPHITE_TCP - Graphite UDP appender.</p></div>
<div class="section">
<h3><a name="How_to_see_the_recorded_measurements.3F"></a>How to see the recorded measurements?</h3>
<div class="section">
<h4><a name="REST_actuator_.2Fmetrics"></a>REST actuator <a class="externalLink" href="https://github.com/zolyfarkas/spf4j-jaxrs/tree/master/spf4j-jaxrs-actuator/src/main/java/org/spf4j/actuator/metrics">/metrics</a></h4>
<p>This endpoint allows you to get to:</p>
<ul>

<li>Your <a class="externalLink" href="https://demo.spf4j.org/metrics/cluster">metrics</a></li>
<li>Their <a class="externalLink" href="https://demo.spf4j.org/metrics/cluster/gc_time">data</a></li>
</ul>
<p>You can get the metrics in any format you might need:</p>
<ul>

<li><a class="externalLink" href="https://demo.spf4j.org/metrics/cluster/gc_time">json</a></li>
<li><a class="externalLink" href="https://demo.spf4j.org/metrics/cluster/gc_time?_Accept=application/avro">avro binary</a></li>
<li><a class="externalLink" href="https://demo.spf4j.org/metrics/cluster/gc_time?_Accept=text/csv">csv</a></li>
<li><a class="externalLink" href="https://demo.spf4j.org/metrics?_Accept=text/plain&amp;from=-PT1H">prometheus</a></li>
</ul>
<p>You can also query your metrics more precisely:</p>
<ul>

<li>Get the metrics for the <a class="externalLink" href="https://demo.spf4j.org/metrics/cluster/gc_time?from=-PT1H">last hour</a>.</li>
<li>Get the metrics for the <a class="externalLink" href="https://demo.spf4j.org/metrics/cluster/gc_time?from=-PT10H">last 10 hours</a></li>
<li>Get the metrics for the <a class="externalLink" href="https://demo.spf4j.org/metrics/cluster/gc_time?from=-PT10H&amp;aggDuration=PT1H">last 10 hours aggregated hourly</a></li>
</ul></div>
<div class="section">
<h4><a name="Via_JMX"></a>Via JMX</h4>
<p>invoke org.spf4j.perf.impl.ms.tsdb.TSDBMeasurementStore/flush to flush all measurements from memory to disk.</p>
<p>invoke org.spf4j.perf.impl.ms.tsdb.TSDBMeasurementStore/getTableAsCsv to get the data from a particular tsdb table as csv.</p>
<p>invoke org.spf4j.perf.impl.ms.tsdb.TSDBMeasurementStore/writeTableAsCsv to write the data from a particular rsdb table to a csv file.</p></div>
<div class="section">
<h4><a name="spf4j-ui"></a><a class="externalLink" href="https://search.maven.org/remotecontent?filepath=org/spf4j/spf4j-ui/8.7.4/spf4j-ui-8.7.4-uber.jar">spf4j-ui</a></h4>
<p>The recorded measurements are saved to a TSDB file. Use the library provided UI (spf4j-ui module) to open the file and visualize the measurements.</p>
<p><img src="images/explorer-ui.png" alt="Explorer UI" /></p>
<p><img src="images/spf4j_dist.png" alt="Distribution Chart" /></p></div>
<div class="section">
<h4><a name="JMX_support"></a>JMX support</h4>
<p>You can annotate with @JmxExport getters and setters of a attribute or any other method that you want to make available via JMX. Here is what you need to do:</p>

<div>
<div>
<pre class="source">    public static final class JmxTest {

        private volatile String stringVal;

        @JmxExport
        public String getStringVal() {
            return stringVal;
        }

        @JmxExport
        public void setStringVal(final String stringVal) {
            this.stringVal = stringVal;
        }

        private static volatile String testStr;

        @JmxExport
        public static String getTestStr() {
            return testStr;
        }

        public static void setTestStr(final String testStr) {
            JmxTest2.testStr = testStr;
        }

    }
...
        // Create object
        JmxTest testObj = new JmxTest();
        // Expose object via JMX (JmxExport annotated methods)
        Registry.export(&quot;test&quot;, &quot;Test&quot;, testObj);


</pre></div></div></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2021
<a href="http://www.spf4j.org">SPF4J</a>.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
